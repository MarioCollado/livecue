name: Build LiveCue

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Permitir ejecución manual
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        python-version: ["3.12"]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install flet flet-desktop flask python-osc pillow nuitka ordered-set zstandard

      - name: Instalar compilador (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install mingw -y
        shell: powershell

      - name: Compilar con Nuitka (Windows)
        if: runner.os == 'Windows'
        run: |
          python -m nuitka --standalone --mingw64 --assume-yes-for-downloads --output-filename=LiveCue.exe --windows-icon-from-ico=icono.ico --include-data-dir=assets=assets --include-data-files=LICENSE=LICENSE --include-data-files=README.md=README.md --include-data-files=COPYRIGHT.md=COPYRIGHT.md --include-package=flet --include-package=flet_desktop --include-package=flet_core --include-package=flet_runtime --include-module=flask --include-module=jinja2 --include-module=werkzeug --nofollow-import-to=matplotlib --nofollow-import-to=numpy --nofollow-import-to=pandas --nofollow-import-to=scipy --nofollow-import-to=tkinter main.py

      - name: Compilar con Nuitka (macOS)
        if: runner.os == 'macOS'
        run: |
          python -m nuitka --standalone --macos-create-app-bundle --assume-yes-for-downloads \
            --output-filename=LiveCue \
            --include-data-dir=assets=assets \
            --include-data-files=LICENSE=LICENSE \
            --include-data-files=README.md=README.md \
            --include-data-files=COPYRIGHT.md=COPYRIGHT.md \
            --include-package=flet \
            --include-package=flet_desktop \
            --include-package=flet_core \
            --include-package=flet_runtime \
            --include-module=flask \
            --include-module=jinja2 \
            --include-module=werkzeug \
            --nofollow-import-to=matplotlib \
            --nofollow-import-to=numpy \
            --nofollow-import-to=pandas \
            --nofollow-import-to=scipy \
            --nofollow-import-to=tkinter \
            main.py

      - name: Debug - Listar archivos generados (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "Contenido del directorio:"
          ls -la
          echo "Buscando archivos .app:"
          find . -name "*.app" -type d
          echo "Buscando carpetas dist:"
          find . -name "*dist" -type d

      - name: Compilar con Nuitka (Linux)
        if: runner.os == 'Linux'
        run: |
          python -m nuitka --standalone --assume-yes-for-downloads \
            --output-filename=LiveCue \
            --include-data-dir=assets=assets \
            --include-data-files=LICENSE=LICENSE \
            --include-data-files=README.md=README.md \
            --include-data-files=COPYRIGHT.md=COPYRIGHT.md \
            --include-package=flet \
            --include-package=flet_desktop \
            --include-package=flet_core \
            --include-package=flet_runtime \
            --include-module=flask \
            --include-module=jinja2 \
            --include-module=werkzeug \
            --nofollow-import-to=matplotlib \
            --nofollow-import-to=numpy \
            --nofollow-import-to=pandas \
            --nofollow-import-to=scipy \
            --nofollow-import-to=tkinter \
            main.py

      - name: Empaquetar distribución (Windows)
        if: runner.os == 'Windows'
        run: |
          Rename-Item -Path "main.dist" -NewName "LiveCue"
          Compress-Archive -Path LiveCue -DestinationPath LiveCue-Windows.zip
        shell: powershell

      - name: Empaquetar distribución (macOS)
        if: runner.os == 'macOS'
        run: |
          # Nuitka en macOS puede crear main.app o main.dist
          if [ -d "main.app" ]; then
            mv main.app LiveCue.app
            zip -r LiveCue-macOS.zip LiveCue.app
          elif [ -d "main.dist" ]; then
            mv main.dist LiveCue
            zip -r LiveCue-macOS.zip LiveCue
          else
            echo "Error: No se encontró main.app ni main.dist"
            ls -la
            exit 1
          fi

      - name: Empaquetar distribución (Linux)
        if: runner.os == 'Linux'
        run: |
          mv main.dist LiveCue
          zip -r LiveCue-Linux.zip LiveCue

      - name: Subir ejecutable
        uses: actions/upload-artifact@v4
        with:
          name: LiveCue-${{ runner.os }}
          path: LiveCue-*.zip
          if-no-files-found: error

      - name: Crear Release (solo en tags)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/LiveCue.exe
            dist/LiveCue.app
            dist/LiveCue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
